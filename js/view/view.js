// Generated by CoffeeScript 1.10.0
(function() {
  var View, ViewPlayer, ViewSettings, checkShowHide, checkShowHideGameMode, mgViewSettings;

  ViewSettings = (function() {
    function ViewSettings() {
      this.fromPlId = -1;
      this.isAttack = false;
      this.currentLevel = null;
    }

    return ViewSettings;

  })();

  mgViewSettings = new ViewSettings();

  window.mgViewSettings = mgViewSettings;

  checkShowHide = function(element, condition) {
    if (condition) {
      return element.show(100);
    } else {
      return element.hide(100);
    }
  };

  checkShowHideGameMode = function(element, gameModeList) {
    return checkShowHide(element, isMode(gameModeList));
  };

  ViewPlayer = (function() {
    function ViewPlayer(player1) {
      this.player = player1;
      this.el = null;
      this.actionShowed = false;
    }

    ViewPlayer.prototype.getEl = function() {
      if (this.el != null) {
        return this.el;
      } else {
        return this.generatePlayer();
      }
    };

    ViewPlayer.prototype.hide = function(time) {
      return this.el.hide(time);
    };

    ViewPlayer.prototype.show = function(time) {
      return this.el.show(time);
    };

    ViewPlayer.prototype.generatePlayer = function() {
      return this.el = $("<tr>").addClass("player").attr("id", "player" + this.player.id).append([$("<td>").addClass("plId"), $("<td>").addClass("plName"), $("<td>").addClass("plHealth"), $("<td>").addClass("plDamage"), $("<td>").addClass("plTreat"), $("<td>").addClass("plSolvedUnsolved"), $("<td colspan='4'>").hide().addClass("plActions").append([btn("solve", "Решена", "green darken-1", this.generateActionClickCallback()), btn("unsolve", "Не решена", "red darken-1", this.generateActionClickCallback()), $("<select act='treat'>").addClass("waves-effect waves-light btn blue darken-1").append([$("<option value='-1'>"), $("<option value='0'>"), $("<option value='1'>"), $("<option value='2'>"), $("<option value='3'>")]).on('change', this.generateActionClickCallback()), btn("penalty", "Штраф", "orange darken-1", this.generateActionClickCallback())])]);
    };

    ViewPlayer.prototype.update = function() {
      var i, len, opt, penalties, ref;
      this.el.removeClass().addClass(this.player.getLevel()).addClass("player");
      penalties = "";
      for (i = 0; i < this.player.penalties; i++) penalties += "*";
      this.el.find(".plId").text(this.player.id);
      this.el.find(".plName").text(this.player.name + penalties);
      this.el.find(".plHealth").text(this.player.health);
      this.el.find(".plDamage").text(this.player.getAttackValue());
      this.el.find(".plTreat").text(this.player.getTreatValue(3));
      this.el.find("select").val(-1);
      ref = this.el.find("option");
      for (i = 0, len = ref.length; i < len; i++) {
        opt = ref[i];
        opt = $(opt);
        if (opt.attr('value') === '-1') {
          opt.text("Задач верно:");
        } else {
          opt.text((opt.attr('value')) + " верно (" + (this.player.getTreatValue(opt.attr('value'))) + ")");
        }
      }
      this.el.find(".plSolvedUnsolved").text(this.player.solved + "/" + this.player.unsolved);
      this.show(1000);
    };

    ViewPlayer.prototype.showActions = function(time) {
      if (!this.actionShowed) {
        this.el.find(".plHealth").hide();
        this.el.find(".plDamage").hide();
        this.el.find(".plTreat").hide();
        this.el.find(".plSolvedUnsolved").hide();
        this.el.find(".plActions").show(time);
        return this.actionShowed = true;
      }
    };

    ViewPlayer.prototype.hideActions = function(time) {
      if (this.actionShowed) {
        this.el.find(".plActions").hide();
        this.el.find(".plHealth").show(time);
        this.el.find(".plDamage").show(time);
        this.el.find(".plTreat").show(time);
        this.el.find(".plSolvedUnsolved").show(time);
        return this.actionShowed = false;
      }
    };

    ViewPlayer.prototype.generateActionClickCallback = function() {
      return (function(_this) {
        return function(e) {
          var actName, target, value;
          target = $(e.currentTarget);
          actName = target.attr('act');
          value = target.val();
          return mgController.actionClick(actName, value);
        };
      })(this);
    };

    ViewPlayer.prototype.remove = function() {
      return this.el.remove();
    };

    return ViewPlayer;

  })();

  View = (function() {
    function View() {
      console.info("Create View");
      this.table = $("#mainTable");
      this.tbody = this.table.find("tbody");
      this.addPlayerButton = $('#addPlayerButton');
      this.modeButtonText = $("#modeText");
      this.viewPlayers = [];
      mgModelSettings.daySecondCallback = (function(_this) {
        return function() {
          return _this.updateTime();
        };
      })(this);
    }

    View.prototype.updatePlayer = function(player) {
      var vPlayer;
      vPlayer = null;
      if (this.viewPlayers.length < player.id + 1) {
        vPlayer = new ViewPlayer(player);
        this.viewPlayers.push(vPlayer);
        this.tbody.append(vPlayer.getEl());
        vPlayer.hide();
      } else {
        vPlayer = this.viewPlayers[player.id];
      }
      vPlayer.player = player;
      return vPlayer.update();
    };

    View.prototype.updatePlayers = function() {
      var i, len, maxId, player, ref;
      maxId = -1;
      ref = mgModel.players;
      for (i = 0, len = ref.length; i < len; i++) {
        player = ref[i];
        this.updatePlayer(player);
        maxId = Math.max(maxId, player.id);
      }
      
    // Длинна меняется во время исполнения цикла
    len = this.viewPlayers.length;
    for (id = maxId + 1; id < len; ++id) {
        var ref;
        if ((ref = this.viewPlayers.pop()) != null) {
            ref.remove();
        }
    };
    };

    View.prototype.updateTime = function() {
      var min, sec, time;
      time = mgModelSettings.time;
      min = Math.floor(time / 60);
      min = min < 10 ? "0" + min : min;
      sec = time % 60;
      sec = sec < 10 ? "0" + sec : sec;
      return this.modeButtonText.text("День (" + min + ":" + sec + ")");
    };

    View.prototype.updatePanel = function() {
      if (isMode(MODE_ADD)) {
        this.modeButtonText.text("Добавление игроков");
      } else if (isMode(MODE_DAY)) {
        this.updateTime();
      } else if (isMode(MODE_NIGHT)) {
        this.modeButtonText.text("Ночь");
      }
      checkShowHideGameMode(this.addPlayerButton, MODE_ADD);
      checkShowHide($("#prevSnap"), snapshotter.isPrev());
      return checkShowHide($("#nextSnap"), snapshotter.isNext());
    };

    View.prototype.update = function() {
      console.log("Update Screen");
      this.updatePanel();
      this.updatePlayers();
      return this.updateActions();
    };

    View.prototype.showActionsOnlyFor = function(plId) {
      var i, len, ref, vPl;
      ref = this.viewPlayers;
      for (i = 0, len = ref.length; i < len; i++) {
        vPl = ref[i];
        if (vPl.player.id === plId) {
          vPl.showActions(300);
        } else {
          vPl.hideActions(0);
        }
      }
    };

    View.prototype.updateActions = function() {
      var i, len, ref, results, vPlayer;
      if (!isMode(MODE_NIGHT)) {
        this.showActionsOnlyFor(-1);
        return;
      }
      if (mgViewSettings.fromPlId === -1) {
        return this.showActionsOnlyFor(-1);
      } else {
        if (mgViewSettings.isAttack) {
          ref = this.viewPlayers;
          results = [];
          for (i = 0, len = ref.length; i < len; i++) {
            vPlayer = ref[i];
            if (vPlayer.player.getLevel() !== mgViewSettings.currentLevel) {
              results.push(vPlayer.el.addClass("not"));
            } else {
              results.push(void 0);
            }
          }
          return results;
        } else {
          this.showActionsOnlyFor(mgViewSettings.fromPlId);
          return $(".player").removeClass("not");
        }
      }
    };

    return View;

  })();

  window.mgView = new View();

  mgView.update();

}).call(this);

//# sourceMappingURL=view.js.map
